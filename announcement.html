<iframe id="loadingScreen" src="/loading" style="position: fixed; width: 100vw; height: 100vh; z-index: 50; background-color: white;"></iframe>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Announcement</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="announcement.css" rel="stylesheet" type="text/css">
    <script>
		window.onload = function () {
            const menu_btn = document.querySelector('.hamburger');
            const mobile_menu = document.querySelector('.mobile-nav');

            menu_btn.addEventListener('click', function () {
                menu_btn.classList.toggle('is-active');
                mobile_menu.classList.toggle('is-active');
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('hoverVideo');
            video.pause();
            video.addEventListener('mouseover', () => {
                video.play();
            });
            video.addEventListener('mouseout', () => {
                video.pause();
                video.currentTime = 0;
            });
        });
        window.addEventListener("load", () => {
        const loadingScreen = document.getElementById("loadingScreen");
        const fadeDuration = 1000; // 1 second
        const intervalTime = fadeDuration / 50;

        loadingScreen.style.opacity = "1";

        setTimeout(() => {
            const fadeOutStep = () => {
                const currentOpacity = parseFloat(loadingScreen.style.opacity) - (1 / 50);
                loadingScreen.style.opacity = currentOpacity;

                if (currentOpacity <= 0) {
                    loadingScreen.style.visibility = "hidden";
                    clearInterval(fadeInterval);
                }
            };
            const fadeInterval = setInterval(fadeOutStep, intervalTime);
            }, 1000);
        });
	</script>	
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3449C7QP0C"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-3449C7QP0C');
</script>
<body>
    <div class="topnav" id="myTopnav">
		<img src="./assets/media/ConvertToSVG.webp" class="hidden" style="height: 8vh; position:fixed; margin-top: 1.5vh; margin-left: 1vw;">
		<video id="hoverVideo" src="https://dl.dropboxusercontent.com/scl/fi/xudtox8mmlvh57rmbprku/logo.webm?rlkey=r31es7ksq7megly241ocx7see&dl=0" class="hidden" type="video/webm" style="z-index: 40; height: 3.5vw; position: fixed; margin-left: 3.6vw;" muted loop></video>
		<nav id="desktopNav">
			<a href="project">Project</a>
			<a href="announcement" class="active">Announcement</a>
			<a href="contact">Contact</a>
			<a href="our_story">Our Story</a>
			<a href="/">Home</a>
		</nav>
		<button class="hamburger">
			<div class="bar"></div>
		</button>
		<div class="mobile-nav">
			<a href="/">Home</a>
			<a href="our_story">Our Story</a>
			<a href="contact">Contact</a>
			<a href="announcement" class="active">Announcement</a>
			<a href="project">Project</a>
		</div>
	</div>
    <h2>official announcement panel</h2>
    <h3>You can also visit our <a href="https://discord.blockstate.team/" target="_blank">Discord server</a> for more information.</h3>
    <div id="messageContainer"></div>
    <script>
        function formatDate(inputDate) {
            if (!inputDate) return ' ';
            const formatDateInternal = (date) => date ? `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}` : 'Invalid Date';
            const date = new Date(inputDate);
            return formatDateInternal(isNaN(date.getTime()) ? null : date);
        }
        function convertDiscordMarkupToHTML(input) {
            const patterns = [
                { regex: /###(.*?)###/g, replacement: '<span class="slightlyBold">$1</span>' },
                { regex: /##(.*?)##/g, replacement: '<span class="bold">$1</span>' },
                { regex: /#(.*?)#/g, replacement: '<span class="veryBold">$1</span>' },
                { regex: /(https:\/\/\S+)/g, replacement: '<a href="$1" target="_blank" class="link">$1</a>' },
                { regex: /@everyone/g, replacement: '<span class="everyone">@everyone</span>' },
                { regex: /\n/g, replacement: '<br>' }
            ];

            let result = input;

            patterns.forEach(({ regex, replacement }) => {
                result = result.replace(regex, replacement);
            });

            return result;
        }
        fetch('https://api.blockstate.team/discordAnnouncement')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(data);
            for (let i = 0 ; i < data.length; i++) {
                document.getElementById('messageContainer').innerHTML +=  '<br>' + '<div class="message">' + `<img class="userAvatar" src="${data[i].avatar}"> <div> <p class="username">${data[i].author} <span class="timestamp">${formatDate(data[i].date)}</span></p>` + convertDiscordMarkupToHTML(data[i].content) + '</div>' + '</div>' + `<div class="line">${formatDate(data[i+1]?.date)}</div>`;
                document.getElementById('messageContainer').style.height = 'auto';
            }
        });
    </script>
</body>
</html>
